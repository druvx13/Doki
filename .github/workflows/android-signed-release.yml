name: Android Signed Release

on:
  # Manual run
  workflow_dispatch:

  # Tag pushes (semantic-style)
  push:
    tags:
      - "v*.*.*"
      - "*.*.*"

permissions:
  contents: write  # required for creating/updating GitHub Releases

env:
  # ðŸ” Keystore + signing config
  # NOTE: Replace KEYSTORE_URL with your real keystore location.
  # It's strongly recommended to move passwords to GitHub Encrypted Secrets.
  KEY_PASSWORD: "password123"
  STORE_PASSWORD: "password123"
  KEY_ALIAS: "kotatsuKey"
  KEYSTORE_URL: "https://raw.githubusercontent.com/druvx13/Doki/main/keystore.b64"

jobs:
  build-signed-release:
    runs-on: ubuntu-latest

    steps:
      # 1) Checkout the repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2) Set up JDK 17 with Gradle cache
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"
          cache: gradle

      # 3) Ensure Gradle wrapper is executable
      - name: Make gradlew executable
        run: chmod +x ./gradlew

      # 4) Download and decode the keystore (pattern kept identical)
      - name: Download Keystore
        run: |
          curl -fL -o keystore.b64 "${{ env.KEYSTORE_URL }}"
          base64 --decode keystore.b64 > release.keystore

      # 5) Build signed release APK(s) for the app module only
      #    This uses the injected signing parameters as requested.
      - name: Build signed release APK
        run: |
          ./gradlew :app:assembleRelease --no-daemon \
            -Pandroid.injected.signing.store.file=$PWD/release.keystore \
            -Pandroid.injected.signing.store.password="${{ env.STORE_PASSWORD }}" \
            -Pandroid.injected.signing.key.alias="${{ env.KEY_ALIAS }}" \
            -Pandroid.injected.signing.key.password="${{ env.KEY_PASSWORD }}"

      # 6) (Optional but helpful) Show where APKs ended up
      - name: List generated APKs
        run: |
          echo "Listing APKs under app/build/outputs:"
          find app/build/outputs -name "*.apk" -print || echo "No APKs found!"

      # 7) Create / update GitHub Release and upload APK(s)
      #    softprops/action-gh-release automatically uses GITHUB_TOKEN.
      - name: Upload APKs to GitHub Release
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch'
        with:
          files: |
            app/build/outputs/apk/release/*.apk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
