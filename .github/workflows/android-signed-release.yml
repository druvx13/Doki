name: Build and Publish Signed Android Release  
  
# Trigger on manual dispatch and version tag pushes  
on:  
  workflow_dispatch:  
  push:  
    tags:  
      - 'v*.*.*'  
      - '*.*.*'  
  
# Grant write permissions to create releases and push artifacts  
permissions:  
  contents: write  
  
jobs:  
  build-and-release:  
    runs-on: ubuntu-latest  
      
    env:  
      # Signing configuration - replace with your own credentials  
      KEY_PASSWORD: "password123"  
      STORE_PASSWORD: "password123"  
      KEY_ALIAS: "kotatsuKey"  
      KEYSTORE_URL: "https://raw.githubusercontent.com/druvx13/Doki/main/keystore.b64"  
      
    steps:  
      # Checkout the repository  
      - name: Checkout repository  
        uses: actions/checkout@v4  
        
      # Set up JDK 17 (required by the project)  
      - name: Set up JDK 17  
        uses: actions/setup-java@v4  
        with:  
          distribution: 'temurin'  
          java-version: '17'  
        
      # Cache Gradle dependencies for faster builds  
      - name: Cache Gradle packages  
        uses: actions/cache@v4  
        with:  
          path: |  
            ~/.gradle/caches  
            ~/.gradle/wrapper  
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}  
          restore-keys: |  
            ${{ runner.os }}-gradle-  
        
      # Make gradlew executable  
      - name: Grant execute permission for gradlew  
        run: chmod +x gradlew  
        
      # Download and decode the keystore from your repository  
      - name: Download and decode keystore  
        run: |  
          echo "Downloading keystore from: ${{ env.KEYSTORE_URL }}"  
          curl -fL -o keystore.b64 "${{ env.KEYSTORE_URL }}"  
          base64 --decode keystore.b64 > release.keystore  
          echo "Keystore downloaded and decoded successfully"  
        
      # Build signed release APK using injected signing parameters  
      - name: Build signed release APK  
        run: |  
          ./gradlew :app:assembleRelease --no-daemon \  
            -Pandroid.injected.signing.store.file=$PWD/release.keystore \  
            -Pandroid.injected.signing.store.password="${{ env.STORE_PASSWORD }}" \  
            -Pandroid.injected.signing.key.alias="${{ env.KEY_ALIAS }}" \  
            -Pandroid.injected.signing.key.password="${{ env.KEY_PASSWORD }}"  
        
      # Find and list the generated APKs  
      - name: List generated APKs  
        run: |  
          echo "Generated APK files:"  
          find app/build/outputs/apk/release -name "*.apk" -type f  
        
      # Upload APKs to GitHub Release  
      - name: Upload APKs to GitHub Release  
        uses: softprops/action-gh-release@v2  
        if: startsWith(github.ref, 'refs/tags/')  
        with:  
          files: app/build/outputs/apk/release/*.apk  
          draft: false  
          prerelease: false  
          generate_release_notes: true  
        env:  
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  
        
      # Upload APKs as workflow artifacts (for manual runs without tags)  
      - name: Upload APKs as artifacts  
        uses: actions/upload-artifact@v4  
        with:  
          name: release-apks  
          path: app/build/outputs/apk/release/*.apk  
          retention-days: 30
